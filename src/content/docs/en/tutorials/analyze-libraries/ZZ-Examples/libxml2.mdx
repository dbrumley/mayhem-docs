---
type: tutorial
title: libxml2 example
order: 0
description: Learn how to check compiled libraries with Mayhem
i18nReady: false
---
import Badge from '~/components/Badge.astro';
import Checklist from '~/components/Checklist.astro';
import Box from '~/components/tutorial/Box.astro';
import Lede from '~/components/tutorial/Lede.astro';

<Lede> Let's harness libxml2, a popular XML library.  </Lede>

There are three main steps for harnessing any library or application:
1. Identify what functions to harness
2. Create and build harnesses for library functions
3. Create an initial test suite corpus

Creating and building the harness is the same as writing a new test.  It
involves:
1. Create a driver that reads input from a file
2. Write any initialization or setup code
3. Call the function(s) under test
4. Create mocks real objects that you cannot use (or do not want to use)
5. Perform any necessary teardown, such as freeing memory.

## Building the library

You will be writing a harness that finds CVE-2015-8317. 

## Check out and build the code

```bash
git clone git@github.com:GNOME/libxml2.git
cd libxml2            

git checkout 726f67e             # Check out code from the time of vulnerability 
CC=afl-clang-fast ./autogen.sh   # Use afl-clang-fast as the compiler
AFL_USE_ASAN=1 make -j 4         # Build the code with AFL 
```

## Hint
<details>
<summary>Hint</summary>
* libxml2 has quite a broad API, but the most tempting target is the core XML parsing logic.
* The parsing functionality is exposed via the [`parser` API](https://gnome.pages.gitlab.gnome.org/libxml2/devhelp/libxml2-parser.html)
</details>

## Answer

<details>
<summary>Answer</summary>

First, write a test driver:
```c
#include "libxml/parser.h"
#include "libxml/tree.h"

int main(int argc, char **argv) {
    if (argc != 2){
        return(1);
    }

    xmlInitParser();
    while (__AFL_LOOP(1000)) {
        xmlDocPtr doc = xmlReadFile(argv[1], NULL, 0);
        if (doc != NULL) {
            xmlFreeDoc(doc);
        }
    }
    xmlCleanupParser();

    return(0);
}
```

You can also make this persistent mode:
```c
#include "libxml/parser.h"
#include "libxml/tree.h"
#include <unistd.h>

__AFL_FUZZ_INIT();

int main(int argc, char **argv) {
    #ifdef __AFL_HAVE_MANUAL_CONTROL
        __AFL_INIT();
    #endif
    unsigned char *buf = __AFL_FUZZ_TESTCASE_BUF;  // must be after __AFL_INIT

    xmlInitParser();
    while (__AFL_LOOP(1000)) {
        int len = __AFL_FUZZ_TESTCASE_LEN;
        xmlDocPtr doc = xmlReadMemory((char *)buf, len, "https://mykter.com", NULL, 0);
        if (doc != NULL) {
            xmlFreeDoc(doc);
        }
    }
    xmlCleanupParser();

    return(0);
}
```
</details>

## Credits

This example comes from the wonderful [AFL training
tutorial](https://github.com/mykter).  

Have your own examples? We'd love for you to submit it as a PR!
